# 用户缓存功能设计

## 实现功能

1. **用户船只排行榜（单个服务器）**

    - 功能: 实现某个船只在某一个服务器下排行榜

    - 数据: 读取 `指定船只id` 和 `指定服务器id` 下所有用户数据，进行处理排序

2. **用户船只排行榜（所有服务器）**

    - 功能: 实现某个船只在全服下的排行榜

    - 数据: 读取 `指定船只id` 下所有用户数据，进行处理排序

3. **指定用户列表排行榜**

    - 功能: 实现在不同服务器的用户列表的排行榜（就是群排名）

    - 数据: 读取 `指定船只id` 下 `指定用户id列表` 数据，进行处理排序

4. **服务器数据统计**

    - 功能: 实现统计某个船只的所有用户数据，计算平均值、近期值等

    - 数据: 读取 `指定船只id` 下所有用户数据，累加计算

## 设计思路

### 数据库设计思路

#### 1. 用户缓存基本信息表

缓存用户的所有船只的基本数据和缓存上次更新时间，用于用户信息的更新，储存的具体是两个数据：

1. 用户上次缓存更新时间，用于更新时判断用户是否需要更新，是否需要更新由用户的活跃等级确定

2. 用户上次更新时数据的缓存，记录所有船只id和数据中的总场数，用于更新时判断是否需要更新数据库

#### 2. 用户缓存具体数据表

数据单位是一个用户的一个船只的数据，记录用户船只的详细数据，用于计算排行榜等数据

```txt
| - 船只id - | - 服务器id - | - 用户id - | --- 具体数据等 --- | - 其他 - |

建立索引: 船只id+服务器id+用户id
```

### 数据库分表思路

根据当前数据规模和预期数据增长规模判断，如果只用一个数据表储存，数量将会超过3kw行数据，需要考虑如何分库或者分表

> 对于当前采用的InnoDB引擎，由于底层的b+树在超过2190w行时，树高度会超过3层，降低效率

对于上面所提到的几个功能里面，索引均包括船只id，所以数据库分表的最小单位是船只id，如果更小会导致数据查询时的问题

对于这个问题，就可以根据船只id来分表，其中船只id又有船只等级、国家、类型等属性，所以有以下几个思路

#### 1. 按照船只id分表

最简单的分表思路，给每一个船只id都新建一个表，只存储这个船只id的数据

但是会导致分出几百个表，不方便管理，其次，每次读取数据前还需要判断表是否存在，降低查询效率

#### 2. 按照船只id的属性分表

根据船只的属性，例如类型或者等级，可以有效降低分出的数据表的数量

但是会导致分出的表内数据极不平衡，例如某个表内数据达到几千万行，但是某个表内只有几十万行，受

### 数据库更新思路


